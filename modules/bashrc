password-gen() {
    head -c 15 /dev/urandom | base64 | tr +/ -_
}

update() {
    apt update
    apt upgrade -y
    apt autopurge -y
    journalctl --vacuum-time=7d
    apt clean
}

make-site() {
    if [ -z $1 ]; then
        echo "make-site <domain> [empty]"
        return 1
    fi
    local NAME=$1
    cd /etc/apache2/sites-available
    if [ -e $NAME.conf ]; then
        echo "Site exists"
        return 1
    fi
    cp 000-default.conf $NAME.conf
    sed -i -e "s/#\(ServerName\).*/\1 $NAME/" \
    -e "s|\(DocumentRoot\).*|\1 /var/www/$NAME/public_html|" $NAME.conf
    a2ensite $NAME
    if [ "$2" != empty ]; then
        cd /var/www
        mkdir $NAME
        cp -r html $NAME/public_html
    fi
    systemctl reload apache2
}

ssl-cert-add() {
    if [ -z $1 ]; then
        echo "ssl-cert-add <domain>"
        return 1
    fi
    local NAME=$1
    if grep ^$NAME$ ~/certs &> /dev/null; then
        echo "Domain exists"
        return 1
    fi
    echo $NAME >> ~/certs
}

ssl-cert-update() {
    if [ -z $1 ]; then
        echo "ssl-cert-update [sites, certs]"
        return 1
    fi
    local NAME=$1
    local LIST
    local MODE
    case $NAME in
        sites) MODE=run
        cd /etc/apache2/sites-enabled
        LIST=$(ls -I "*ssl.conf" | sed "s/\.conf//" | paste -sd,);;
        certs) MODE=certonly
        LIST=$(paste -sd, ~/certs);;
        *) echo "Certificate does not exists"; return 1;;
    esac
    certbot $MODE --apache --cert-name $NAME --expand -d $LIST
}

mariadb-create-user() {
    if [ -z $1 ]; then
        echo "mariadb-create-user <name> => <password>"
        return 1
    fi
    local NAME=$1
    local PASSWORD=$(password-gen)
    echo $PASSWORD
    mariadb -e "create database if not exists $NAME;
    create user $NAME@localhost identified by '$PASSWORD';
    grant select, insert, update, delete on $NAME.* to $NAME@localhost;"
}

mail-add-domain() {
    if [ -z $1 ]; then
        echo "mail-add-domain <domain>"
        return 1
    fi
    NAME=$1
    mariadb -e "insert into mail.domains values (null, '$NAME')"
}

mail-add-user() {
    if [ -z $1 ]; then
        echo "mail-add-user <user>@<domain> => <password>"
        return 1
    fi
    local USERNAME=${1%@*}
    local DOMAINNAME=${1#*@}
    local PASSWORD=$(password-gen)
    echo $PASSWORD
    PASSWORD=$(doveadm pw -p $PASSWORD -s BLF-CRYPT)
    mariadb -e "insert into mail.users values (null, '$USERNAME', '${PASSWORD#*\}}', (select id from mail.domains where domain = '$DOMAINNAME'))"
}
